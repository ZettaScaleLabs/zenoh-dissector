name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  schedule:
    - cron: "0 6 * * 1-5"

env:
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  markdown_lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DavidAnson/markdownlint-cli2-action@v18
        with:
          config: '.markdownlint.yaml'
          globs: '**/README.md'

  platform_checks:
    name: Run checks on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-2022
            platform: windows

    steps:
      - uses: actions/checkout@v4

      - uses: hustcer/setup-nu@v3
        with:
          version: '0.100'

      - name: Extract Wireshark version from Cargo.toml
        id: wireshark-version
        shell: nu {0}
        run: |
          let version = (open Cargo.toml | get workspace.metadata.wireshark_version)
          $"version=($version)" | save --append $env.GITHUB_OUTPUT

      - name: Install Rust components
        run: |
          rustup component add rustfmt clippy

      - name: Code format check
        run: cargo fmt -- --check

      - name: Install Wireshark (Ubuntu)
        if: matrix.platform == 'linux'
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt install -y software-properties-common
          sudo add-apt-repository -y ppa:wireshark-dev/stable
          sudo apt install -y wireshark-dev
          sudo apt install -y --allow-change-held-packages wireshark tshark

      - name: Install Wireshark (macOS)
        if: matrix.platform == 'macos'
        # We will link the /Applications/Wireshark.app/Contents/Frameworks/libwireshark.*.dylib
        # to libwireshark.dylib under the project folder to prevent the privilege issue
        run: |
          brew install --cask wireshark
          ln -snf $(find /Applications/Wireshark.app/Contents/Frameworks -name "libwireshark.*.dylib" | tail -n 1) libwireshark.dylib
          ln -snf $(find /Applications/Wireshark.app/Contents/Frameworks -name "libwiretap.*.dylib" | tail -n 1) libwiretap.dylib
          ln -snf $(find /Applications/Wireshark.app/Contents/Frameworks -name "libwsutil.*.dylib" | tail -n 1) libwsutil.dylib
        env:
          WIRESHARK_LIB_DIR: ${{ github.workspace }}

      - name: Install Wireshark (Windows)
        if: matrix.platform == 'windows'
        shell: nu {0}
        run: |
          let installed = (choco list -l -r --id-only | lines)
          let install_list = ["xsltproc", "docbook-bundle", "nsis", "winflexbison3", "cmake", "7zip"]

          for pkg in $install_list {
            if $pkg not-in $installed {
              choco install -y --force --no-progress $pkg
            }
          }

          choco install -y --no-progress wireshark --version $"${{ steps.wireshark-version.outputs.version }}.0"

      - name: Enable long path support
        if: matrix.platform == 'windows'
        run: |
          powershell -Command "
          New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem' -Name 'LongPathsEnabled' -Value 1 -Force
          "

      - name: Build Wireshark from source (Windows)
        if: matrix.platform == 'windows'
        shell: powershell
        run: |
          & .\epan-sys\scripts\build.ps1 -WiresharkVersion "${{ steps.wireshark-version.outputs.version }}" -BuildConfig "Release"

      - name: Clippy
        run: cargo clippy --all-targets -- --deny warnings
        env:
          WIRESHARK_LIB_DIR: ${{ matrix.platform == 'macos' && github.workspace || '' }}

      - name: Build
        run: cargo build
        env:
          WIRESHARK_LIB_DIR: ${{ matrix.platform == 'windows' && 'C:\\wsbuild\\build\\run\\Release' || (matrix.platform == 'macos' && github.workspace || '') }}

      - name: Place the plugin
        shell: nu {0}
        run: |
          let platform = "${{ matrix.platform }}"
          let full_version = "${{ steps.wireshark-version.outputs.version }}"

          # Extract major.minor version (e.g. 4.6.0 -> 4.6)
          let base_version = ($full_version | split row '.' | first 2 | str join '.')

          # macOS uses dash format (e.g. 4-4 instead of 4.4)
          let version = if $platform == "macos" {
            $base_version | str replace '.' '-'
          } else {
            $base_version
          }

          let plugin_dir = if $platform == "windows" {
            $"($env.APPDATA)/Wireshark/plugins/($version)/epan"
          } else {
            $"($env.HOME)/.local/lib/wireshark/plugins/($version)/epan"
          }

          let lib_name = match $platform {
            "windows" => "zenoh_dissector.dll",
            "macos" => "libzenoh_dissector.dylib",
            _ => "libzenoh_dissector.so"
          }

          let plugin_name = if $platform == "windows" {
            "zenoh_dissector.dll"
          } else {
            "libzenoh_dissector.so"
          }

          mkdir -v $plugin_dir
          cp -v $"./target/debug/($lib_name)" $"($plugin_dir)/($plugin_name)"

      - name: Test the sample data
        shell: nu {0}
        run: |
          let platform = "${{ matrix.platform }}"

          let output = if $platform == "windows" {
            ^'C:/Program Files/Wireshark/tshark.exe' -r ./assets/sample-data.pcap
          } else {
            tshark -r ./assets/sample-data.pcap
          }

          let zenoh_count = ($output | lines | where {|line| $line =~ "Zenoh"} | length)

          if $zenoh_count != 7 {
            error make {msg: $"Expected 7 Zenoh packets, found ($zenoh_count)"}
          }

  # NOTE: In GitHub repository settings, the "Require status checks to pass
  # before merging" branch protection rule ensures that commits are only merged
  # from branches where specific status checks have passed. These checks are
  # specified manually as a list of workflow job names. Thus we use this extra
  # job to signal whether all CI checks have passed.
  ci:
    name: CI status checks
    runs-on: ubuntu-latest
    needs:
      - platform_checks
      - markdown_lint
    if: always()
    steps:
      - name: Check whether all jobs pass
        run: echo '${{ toJson(needs) }}' | jq -e 'all(.result == "success")'
